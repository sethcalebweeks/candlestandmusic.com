---
import { getCollection } from 'astro:content';
import { Icon } from 'astro-icon';
import PlaySong from '../../components/PlaySong.svelte';
import Links from '../../components/Links.astro';

import Layout from '../../layouts/Layout.astro';
import albums from '../../albums.json';
import restore from '../../images/restore.jpg';
import noahsart from '../../images/noahs-art.jpg';
import mercifulAndMighty from '../../images/merciful-&-mighty.jpg';

interface Props {
  slug: string;
  name: string;
  cover: ImageMetadata;
}

export function getStaticPaths() {
  const albumCovers: {[slug: string]: ImageMetadata} = {
    "merciful&mighty": mercifulAndMighty,
    restore,
    noahsart,
  }
  return albums.map((album) => ({
    params: {album: album.slug},
    props: {cover: albumCovers[album.slug], ...album}
  }))
}

const { slug, name, cover, ...rest } = Astro.props;

const tracks = (await getCollection('tracks', ({id}) => {
    return id.startsWith(slug.replace("&", "_and_"))
  })).map(({slug, ...rest}) => ({
    ...rest,
    slug: `/${slug.replace("_and_", "&").replace(/\d{2}_/, "")}`
  }))
---

<Layout title={name}>
	<main class="flex min-h-0 flex-col md:flex-row pb-4 pt-16 2xl:pt-[5rem] h-full w-full">
    <div class="p-4 flex flex-col flex-1 align-middle max-h-[70vh] items-center pb-20">
      <img src={cover.src} alt={name} class="h-full flex-shrink shadow-lg shadow-black"  /> <!--transition:name={cover.src} -->
      <Links {...rest} />
    </div>
    <div class="p-4 flex-1 min-w-[24rem] w-full">
      <ol class="block"> 
        {tracks.map(({data: {title}, slug}) => (
          <li class="my-2 p-2 bg-black bg-opacity-50 flex rounded text-white">
            <PlaySong song={slug} client:load>
              <Icon name="ic:baseline-play-arrow" class="h-6 w-6" />
            </PlaySong>
            <span class="flex-grow px-2">{title}</span>
            <a href={slug} class="px-2">Lyrics</a>
          </li>
        ))}
      </ol>
    </div>
	</main>
</Layout>
